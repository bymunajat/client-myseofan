RewriteEngine On
# RewriteBase /

# ----------------------------------------------------------------------
# SECURITY HEADERS & RULES
# ----------------------------------------------------------------------

# 1. Block access to sensitive files
<FilesMatch "\.(db|sqlite|log|ini|sh|git|env|lock)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 2. Block access to specific system names
<FilesMatch "^(composer\.json|package\.json|readme\.md|license|changelog\.md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 2b. Block access to sensitive directories
RewriteRule ^(scripts|includes|migrations|database)/ - [F,L]

# 3. Disable Directory Browsing
Options -Indexes

# 4. Redirection & URL Rewriting
# ----------------------------------------------------------------------

# Redirect index.php to /
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /index\.php\ HTTP/
RewriteRule ^index\.php$ / [R=301,L]

# SEO Friendly URLs for Downloader Pages (Language first)
# Format: /id/photo-downloader
RewriteRule ^([a-z]{2})/video-downloader/?$ video.php?lang=$1 [QSA,L]
RewriteRule ^([a-z]{2})/photo-downloader/?$ photo.php?lang=$1 [QSA,L]
RewriteRule ^([a-z]{2})/reels-downloader/?$ reels.php?lang=$1 [QSA,L]
RewriteRule ^([a-z]{2})/igtv-downloader/?$ igtv.php?lang=$1 [QSA,L]
RewriteRule ^([a-z]{2})/carousel-downloader/?$ carousel.php?lang=$1 [QSA,L]

# Blog & Posts (Language first)
RewriteRule ^([a-z]{2})/blog/?$ blog.php?lang=$1 [QSA,L]
RewriteRule ^([a-z]{2})/post/([^/]+)/?$ post.php?slug=$2&lang=$1 [QSA,L]

# Static Pages (Language first)
RewriteRule ^([a-z]{2})/page/([^/]+)/?$ page.php?slug=$2&lang=$1 [QSA,L]

# Language Home: /id
RewriteRule ^([a-z]{2})/?$ index.php?lang=$1 [QSA,L]

# --- Fallbacks (No language prefix) ---
RewriteRule ^blog/?$ blog.php [QSA,L]
RewriteRule ^video-downloader/?$ video.php [QSA,L]
RewriteRule ^photo-downloader/?$ photo.php [QSA,L]
RewriteRule ^reels-downloader/?$ reels.php [QSA,L]
RewriteRule ^igtv-downloader/?$ igtv.php [QSA,L]
RewriteRule ^carousel-downloader/?$ carousel.php [QSA,L]
RewriteRule ^post/([^/]+)/?$ post.php?slug=$1 [QSA,L]
RewriteRule ^page/([^/]+)/?$ page.php?slug=$1 [QSA,L]

# 1. Redirect .php requests to clean URLs (External)
# Use THE_REQUEST to avoid matching internal rewrites (prevents redirect loops)
RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ /([^\ ]+)\.php
RewriteRule ^/?(.*)\.php$ /%1 [L,R=301]

# 2. Generic .php internal rewrite
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME}\.php -f
RewriteRule ^([^\.]+)$ $1.php [NC,L]
